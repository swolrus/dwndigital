{% extends the_template %}
{% block title %}PAYPAL CHECKOUT{% endblock %}
{% block content %}
  <section>
    <h3>CHECKOUT</h3>
  </section>
  <section>
    <h4>Pre-order Details</h4>
    <p>1 x {{ item.name}} for {{ item.price }} AUD</h4>
  </section>
  <section>
    <form action="/action_page.php">
      <h4>Please Fill Out Your Details</h4>
      <label for="fname"><i class="fas fa-user"></i> Full Name</label>
      <input type="text" id="fname" name="firstname" placeholder="Chuck A. Wobble">
      <label for="email"><i class="fas fa-envelope"></i> Email</label>
      <input type="text" id="email" name="email" placeholder="chuck@example.com">
      <label for="adr"><i class="fas fa-map-pin"></i> Address</label>
      <input type="text" id="adr" name="address" placeholder="41 Otherside Lane">
      <label for="city"><i class="fas fa-building"></i> City</label>
      <input type="text" id="city" name="city" placeholder="Lushville">
      <div class="row">
        <div class="col-6">
          <label for="state">State</label>
          <input type="text" id="state" name="state" placeholder="LAU">
        </div>
        <div class="col-6">
          <label for="zip">Zip</label>
          <input type="number" id="zip" name="zip" placeholder="6281">
        </div>
      </div>
      <div id="paypal-button"></div>
    </form>
  </section>
{% endblock %}
{% block script %}
<script>
  paypal.Buttons({
    style: {
      layout: 'vertical',
      color:  'black',
      shape:  'rect',
      label:  'paypal'
    },
    fundingSource: paypal.FUNDING.PAYPAL,
    createOrder: function(data, actions) {
      return actions.order.create({
        application_context: {
          brand: 'KAIMAN x POSTED',
        },
        purchase_units: [{
          amount: {
            value: '{{ item.price }}',
            quantity: '1',
          },
        }]
      });
    },
    onApprove: function(data, actions) {

      // Authorize the transaction
      actions.order.authorize().then(function(authorization) {

        // Get the authorization id
        var authorizationID = authorization.purchase_units[0]
          .payments.authorizations[0].id

        // Call your server to validate and capture the transaction
        return fetch('payments/paypal-transaction-complete', {
          method: 'post',
          headers: {
            'content-type': 'application/json'
          },
          body: JSON.stringify({
            orderID: data.orderID,
            authorizationID: authorizationID
          })
        });
      });
    },
    onError: function (err) {
      // For example, redirect to a specific error page
      window.location.href = "/errors";
    }
  }).render('#paypal-button');
</script>
{% endblock %}